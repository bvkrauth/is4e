# Multivariate data analysis

```{r setup12, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
EmpData <- read_csv("EmploymentData.csv")
# Make permanent changes to EmpData
EmpData <- EmpData %>%
  mutate(MonthYr = as.Date(MonthYr,"%m/%d/%Y")) %>% 
  mutate(UnempPct = 100*UnempRate) %>% 
  mutate(LFPPct = 100*LFPRate)
```

:::goals
**Chapter goals**

In this chapter we will learn how to:

- Construct and interpret a pivot table.
- Calculate and interpret common multivariate statistics such as covariance 
  and correlation.
- Calculate conditional frequencies, covariances and 
  correlations from a table of data.
- Describe the relationship between two random variables
  using the conditional expectation function (CEF).
- Use the CEF to construct predictions.
- Distinguish between methods of estimating a CEF 
  (conditional averages, linear regression, and smoothing)
  and interpret an estimated CEF.
:::

## Multivariate statistical methods

### Multivariate statistics in R

Multivariate statistics like covariance and correlation
can be cauclulated 
```{r}
# For two specific columns of data
cov(EmpData$UnempRate,EmpData$LFPRate)
cor(EmpData$UnempRate,EmpData$LFPRate)
```
They can also be calculated for the whole data set
```{r}
# For the whole data set
EmpData %>%
  select(where(is.numeric)) %>%
  cor()
```
Dealing with missing values is a little more complicated for covariances and correlations because there are two different ways to drop them:

1. Pairwise deletion: when calculating the covariance of two variables, 
   drop observations with a missing values for either of *those two* variables.
2. Casewise or listwise deletion: when calculating the covariance of two
   variables, drop observations with a missing value for *any* variable.

The `use` argument allows you to specify which approach you want to use:
```{r}
# EmpData has missing data in 1976 for the variable AnnPopGrowth
# Casewise deletion will exclude 1976 from all calculations
EmpData %>%
  select(where(is.numeric)) %>%
  cor(use="complete.obs")
# Pairwise deletion will exclude 1976 from calculations involving AnnPopGrowth
EmpData %>%
  select(where(is.numeric)) %>%
  cor(use="pairwise.complete.obs")

```
In most applications, pairwise deletion makes the most sense 


### Sample covariance and correlation

The sample covariance of $x_i$ and $y_i$ is:
  $$s_{x,y} = \frac{1}{n-1} \sum_{i=1}^n (x_i-\bar{x})(y_i-\bar{y})$$
and their sample correlation is:
  $$\rho_{x,y} = \frac{s_{x,y}}{s_x s_y}$$
where $s_{x,y}$ is the sample covariance, $s_{x}$ is the sample
standard deviation of $x_i$ and $s_{y}$ is the sample 
standard deviation of $y_i$.

For example, suppose that we have the following data:

> INSERT TABLE HERE: 2 columns (x and y), 3 rows of data

Then we can calculate:
  $$\bar{x} = \frac{1}{n-1}\sum_{i=1} x_i = ?$$
  $$\bar{y} = \frac{1}{n-1}\sum_{i=1} y_i = ?$$
  $$s_{x} = \frac{1}{n-1}\sum_{i=1} (x_i - \bar{x})^2 = ?$$
  $$s_{y} = \frac{1}{n-1}\sum_{i=1} (y_i - \bar{y})^2 = ?$$
  $$s_{xy} = \frac{1}{n-1}\sum_{i=1} (x_i - \bar{x})(y_i - \bar{y}) = ?$$
  $$s_{xy} = \frac{s_{xy}}{s_{x}s_{y}} = \frac{?}{? + ?} = ?$$

> The sample covariance and correlation can be calculated in Excel
> using the `COVARIANCE.S()` and `CORREL()` functions.

The sample covariance and correlation have several properties:

- The sample covariance is a consistent and unbiased estimator of the 
  (population) covariance.
- The sample correlation is a consistent (but not unbiased) estimator
  of the (population) correlation.
- As with the population correlation, the sample correlation ranges 
  from -1 to 1.

### Joint and conditional frequencies

See conditional averages below.



    

We can also make a scatter plot showing the relationship between the 
unemployment rate and the labour force participation rate:
```{r}
ggplot(data=EmpData,aes(x=UnempRate,y=LFPRate)) + 
  geom_point()
```



```{r}
ggplot(data=EmpData,aes(x=UnempRate,y=LFPRate)) + 
  geom_point(col="red")
```

You can also color-code a geographic element based on some other variable by 
including it as part of the aesthetic:
```{r}
ggplot(data=EmpData,aes(x=UnempRate,y=LFPRate)) + 
  geom_point(aes(col=Party))
```

As we discussed earlier, you want to make sure your graph can be read by a reader
who is color blind or is printing in black and white. So we can use 
shapes in addition to color:
```{r}
ggplot(data=EmpData,aes(x=UnempRate,y=LFPRate)) + 
  geom_point(aes(col=Party, shape=Party))
```
For example, suppose we want to add a smooth fit to our scatter 
plot. We can do that with the `geom_smooth()` geometry:
```{r}
ggplot(data=EmpData,aes(x=UnempRate,y=LFPRate)) + 
  geom_point() +
  geom_smooth()
```
Notice that by default, the graph includes both the fitted line
(in blue) and a 95\% confidence interval (the shaded area around
the line).  

Alternatively, we could add a linear fit:
```{r}
ggplot(data=EmpData,aes(x=UnempRate,y=LFPRate)) + 
  geom_point() +
  geom_smooth(method="lm") 
```


Here is our scatter plot:
```{r}
ggplot(data=EmpData %>% filter(Party != "Transfer"),
       aes(x=UnempRate,y=LFPRate)) + 
  geom_point(aes(col=Party, shape=Party)) +
  geom_smooth(aes(col=Party)) +
  labs(title="Unemployment and LFP rates by party in government",
      subtitle=paste("January 1976 - January 2021 (",
                     nrow(EmpData),
                     " months)",
                     sep="",
                     collapse=""),
      caption="Source: Statistics Canada, Labour Force Survey",
      tag="Canada") +
  xlab("Unemployment rate") +
  ylab("Labour force participation")
```


### Estimating conditional expectations

#### Conditional averages

When our conditioning variable $x_i$ only takes on a 
few values, the CEF can be estimated by constructing ***conditional averages***:

1. Dividing up the sample into $k$ subsamples, one for each possible value of $x_i$
2. Averaging $y_i$ within each subsample.

For example, suppose we want to estimate the CEF of earnings given (binary)
gender using the following table of data from a random sample of Canadians:

> INSERT TABLE OF DATA HERE

We  can use the average earnings of women in our sample to estimate the mean
earnings of women in the population, and the average earnings of men in 
our sample to estimate the mean earnings of men in the population.

> The conditional average can be calculated in Excel
> using the `AVERAGEIF()` function.

The conditional average is just an average, so all of the results we have
learned for averages apply: 

- It is an unbiased and consistent estimator of the corresponding 
  conditional mean.
- It is asymptotically normal, and we can use the same formulas for standard
  errors, hypothesis tests, and confidence intervals as we use for regular
  averages/means.

When $x_i$ is continuous, or takes on many values, we run into some problems
with the conditional average:

- The subsamples become very small, and so the averages become very noisy.  
- The results are often hard to intepret.

So we will also need some other techniques.

#### Linear regression

One solution is to assume that the CEF is a straight line, or can be
well-approximated by a straight line.  In that case we can estimate
the CEF by a technique called ***linear regression***.  Linear
regression calculates the straight line that fits the data best.

> EXAMPLE PLOT HERE: scatter plot with (good) linear fit

You will learn much more about linear regression in ECON 333.

#### Binning and smoothing

Figure ??? below shows an example in which $x_i$ takes on many values 
(so conditional averages won't work) and the relationship betwee
$x_i$ and $y_i$ is clearly not linear (so linear regression will be misleading).
What do we do there?

> EXAMPLE PLOT HERE: scatter plot with bad linear fit

One solution is to divide the range for $x_i$ into a set of ***bins** and then
take averages within each bin. We can then plot the average $y_i$ within each
bin against the midpoint of the bin. Figure ??? below shows the result of 
binning our data.

> EXAMPLE PLOT HERE: scatter plot with binned fit

Another solution is to ***smooth***.  There are many different techiques for 
smoothing, but they are all based on taking a weighted average of $y_i$ near 
each point, with high weights on observations with $x_i$ close to 
that point and low (or zero) weights on observations with $x_i$ far 
from that point.  Figure ??? below shows the result of smoothing our data.

> EXAMPLE PLOT HERE: scatter plot with smoothed fit

Both binning and smoothing require the analyst to choose how smooth she wants
the estimated CEF to be:

  - In binning, this is determined by the number of bins. 
    - The first graph in Figure ??? shows fewer bins
    - The second graph in Figure ??? shows more bins
  - In smoothing, this is determined by some smoothing parameter.
    - The first graph in Figure ??? shows a smoother relationship
    - The second graph in Figure ??? shows a lsss smooth relationship

Computer programs that do binning or smoothing usually have some default
way of setting these parameters so the results look reasonable.

> EXAMPLE PLOT HERE: binned fit, fewer bins and more bins
> EXAMPLE PLOT HERE: scatter plot with smoothed fit, oversmoothed and undersmoothed



###  Excel pivot tables

Pivot tables are quite powerful but somewhat tricky to use. 

#### A simple pivot table

Let's start by creating a simple pivot table

1. Click anywhere in your data table.
2. Select `Insert` and then `PivotTable` 
3. Excel will display a dialog box allowing you to specify the range of
  your data along with a few other options.  THe default here is fine,
  so click on `OK`.
  
You will now see something like this:

> INSERT SCREENSHOT HERE.

Let's start with a simple one-variable table. Check the box next to "Gender,"
and you will see something like this:

> INSERT SCREENSHOT HERE.

We now can report various statistics broken down by gender.  Let's start with 
a simple count.  Drag "Gender" into the box marked "$\Sigma$ values". You
will see something like this:

> INSERT SCREENSHOT HERE.

As we can see, it shows the number of observations for each value of Gender.
Suppose we want to change it from a count to a percentage.  Then right-click
on "Count of Gender", then on "Show Values As" and then on "% of column total."
You will now see a screen like this:

> INSERT SCREENSHOT HERE.

Now let's see what income by gender looks like.  Drag "Income" into the 
box marked "$\Sigma$ values".  You will now see a screen that looks like 
this:

> INSERT SCREENSHOT HERE.

Unfortunately, we wanted to see the average income by gender, but instead
we see the sum of income for each gender.  We can change that by right-clicking
on "Sum of Income", then on "Summarize Values By" and then "Average".

We can keep adding variables, and ways to summarize them. But there
are other things we can do.

#### Improving our pivot table

- We can sort rows by any column in the table.
- We can filter rows out of the table:
  - We can do this on our row label by clicking on the first column header
    and selecting the filter we want.
  - We can also filter on any other variable by dragging that variable name
    into the "Filters" box.


