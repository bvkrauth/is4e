# Using R

```{r setup11, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("tidyverse")
simdat <- tibble(xval=sort(rnorm(100)),
                 yval=sign(xval)+0.3*rnorm(100),
                 zval=as.integer(round(runif(100))))
simdat$tmpval <- simdat$xval
simdat$tmpval[simdat$xval < 0] <- NA
```

In this chapter we will learn how to:

 - Produce simple graphs in R.



## Data analysis with R

### Reading data from a CSV file

Our first step will be reading the data in from the CSV file. The tidyverse 
function to do this is called `read_csv()`:
```{r}
book1 <- read_csv("book1.csv")
print(book1)
```


### Tibbles

The `read_csv()` function creates an object called a ***tibble***. A 
tibble is an object type that corresponds to a table in tidy data. Each 
row in the tibble is an observation, and each column is a variable with 
a name. The base R equivalent of a tibble is called a data.frame. In most applications tibbles and data.frames are interchangeable, but tibbles
have some additional features that make them work better.

We can obtain the column names of a tibble using the `names()` function:
```{r}
names(book1)
```
and we can count the rows and columns with `nrow()` and `ncol()` respectively:
```{r}
nrow(book1)
ncol(book1)
```
We can access any variable by name using the `$` notation:
```{r}
print(book1$Gender)
```
We can also access any row (or rows) in  our tibble by number or logical condition,
and any column by number or name:
```{r}
print(book1[1,])
print(book1[,"Gender"])
print(book1[book1$Gender == "Male","Name"])
```


### Some basic statistical functions

#### Summary statistics

Summary statistics:
```{r}
summary(simdat)
```


#### Means

Means
```{r}
# Mean of a single variable
mean(simdat$xval)
# if a variable has any NA values, its mean will be NA 
mean(simdat$tmpval)
# unless you tell R to remove them
mean(simdat$tmpval,na.rm=TRUE)
# Mean of each column
colMeans(simdat,na.rm=TRUE)
```

#### Other univariate statistics

Variance and standard deviation:
```{r}
var(simdat$xval,na.rm = TRUE)
sd(simdat$xval,na.rm = TRUE)
apply(simdat,2,var,na.rm=TRUE)
apply(simdat,2,sd,na.rm=TRUE)

```

Counts
```{r}
count(simdat,zval)
count(simdat,cut_width(xval,0.5))
```

#### Multivariate statistics

Covariance and correlation:
```{r}
# For two specific 
cov(simdat$xval,simdat$yval)
cor(simdat$xval,simdat$yval)
cov(simdat)
cor(simdat)
```
Dealing with missing values is a little more complicated for covariances and correlations because there are two different ways to drop them:

1. Pairwise deletion: when calculating the covariance
  of two variables, drop observations with a missing
  values for either of *those two* variables.
2. Casewise or listwise deletion: when calculating the covariance
  of two variables, drop observations with a missing
  value for *any* variable.

```{r}
# Pairwise deletion 
cov(simdat,use="pairwise.complete.obs")
# Casewise deletion 
cov(simdat,use="complete.obs")
```

#### Probability distributions

R has a family built-in functions for each commonly-used probability
distribution.  We have already seen `dnorm()` function, which 
gives the normal PDF:
```{r}
# The N(0,1) PDF, evaluated at 1.96
dnorm(1.96)
# The N(1,4) PDF, evaluated at 1.96
dnorm(1.96,mean=1,sd=4)
# The N(0,1) CDF, evaluated at 1.96
pnorm(1.97)
# The 2.5 percentile of the N(0,1) CDF
qnorm(0.025)
# Four random numbers from the N(0,1) distribution
rnorm(4)
```
There is a similar set of functions available for the 
uniform distribution (dunif, punif, qunif,runif), the
binomial distribution (dbinom,,pbinom,qbinom,rbinom),
and Student's T distribution (dt,pt,qt,rt), along 
with many others.

## Graphing with ggplot

### Making a simple graph

#### Making a histogram

We can make a histogram
```{r}
ggplot(data=simdat,mapping=aes(x=xval)) + 
  geom_histogram()
```
This is already a pretty nice graph, though it could use some customization.

The `ggplot()` function has a non-standard syntax, so I'd like to go over 
it. 

- The first part `ggplot(data=simdat,mapping=aes(x=xval))` sets up
  the basic characteristics of the graph:
    - The `data` argument tells R which data set (tibble) will be
      used
    - the `mapping` argument describes the basic ***aesthetics***
      of the graph, i.e., the relationship in the data we will
      be graphing.
- The rest of the command is one or more statements separated by 
  a `+` sign.  These are called ***geometries*** and are geometric
  elements to be included in the plot.
    - The geom_hist() geometry produces a histogram


Explain this...
```{r}
# The default is to plot the number of cases
# But often we want to plot the proportion of cases
ggplot(data=simdat,mapping=aes(x=xval)) + 
  geom_histogram(aes(y=..density..))
```


#### Making a line graph

```{r}
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_line()
```


#### Making a scatter plot

We can also make a scatter plot
```{r}
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_point()
```
This is different from our histogram in two ways:
  - The geometry is geom_point rather than geom_hist.
  - The aesthetic also includes a `y` value, as require to plot $(x,y)$


### Customizing your graph

#### Titles and labels

Titles: You can add a title and subtitle, and you can change the axis titles: 
```{r}
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_point() + 
  labs(title="Main title here",
      subtitle="subtitle here",
      caption="caption here",
      tag="tag here") +
  xlab("x label here") +
  ylab("y label here")
```

#### Color and shapes

Using color: you can change the color of any geometric element
using the `col=` argument:
```{r}
# You can fix the color of a geographic element at a preferred value
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_point(col="red") 
```

You can also color-code a geographic element based on some other variable by including it as part of the aesthetic
```{r}
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_point(aes(col=as.factor(zval)))
```

Using shapes: you want to make sure your graph can be read by a reader
who is color blind or is printing in black and white. So we can use 
shapes in addition to color:
```{r}
# You can also color-code a geographic element based on some other variable
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_point(aes(col=as.factor(zval),shape=as.factor(zval)))
```

### Adding plot elements 

We can include multiple geometries in the same graph.

For example, suppose we want to add a smooth fit to our scatter 
plot. We can do that with the `geom_smooth()` geometry:
```{r}
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_point() +
  geom_smooth()
```
Notice that by default, the graph includes both the fitted line
(in blue) and a 95\% confidence interval (the shaded area around
the line).  

Alternatively, we could add a linear fit:
```{r}
ggplot(data=simdat,aes(x=xval,y=yval)) + 
  geom_point() +
  geom_smooth(method="lm") 
```

Finally, there is no built-in option to generate a binned 
scatterplot, but we can do it with a little work:
```{r}
ggplot(data=simdat,aes(x=xval,y=yval)) + 
 geom_point(size=0.5) +
  stat_summary_bin(fun='mean', bins=20,
                   col="blue", size=3, geom='point') +
  stat_summary_bin(fun='mean', bins=20,
                   col="blue", size=0.5, geom='line')
```
It took me a little while to figure this one out - I wouldn't 
expect you to do anything so complicated.

### A few other graphs

The histogram, time series (line) graph and scatter plot 
are the core graphs I want you to be able to produce. But ggplot2
has many other pretty and useful graphs, so I would like to show
you a few of them.

Some alternatives to the histogram include:
```{r}
# A smooth density (PDF) function too
ggplot(data=simdat,mapping=aes(x=xval)) +
  geom_density()
# Histograms don't work well for discrete variables
ggplot(data=simdat,mapping=aes(x=zval)) +
  geom_histogram()
# geom_freqpoly is recommended instead
ggplot(data=simdat,mapping=aes(x=zval)) +
  geom_freqpoly()
# This is called a box plot. It shows the mean
ggplot(data=simdat,mapping=aes(x=xval,y=as.factor(zval))) + 
  geom_boxplot()
```
We can put two densities in the same graph for comparison: 
```{r}
# The fill option changes the color under the density
# The alpha option makes the fill partially transparent
ggplot(data=simdat) + 
  geom_density(aes(x=xval),fill="red",alpha=0.5) +
  geom_density(aes(x=yval),fill="blue",alpha=0.5)
```

## Data cleaning with R (if time allows)


### Some basic data-cleaning functions

#### filter


#### select

#### arrange

#### mutate

